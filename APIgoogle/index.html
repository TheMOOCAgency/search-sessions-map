<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Courses Sessions</title>
    <!-- BOOTSTRAP-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <!-- DATE PICKER -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <!-- MOMENT JS-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/locale/fr.js"></script>

    <style>
      #map {
        height: 50vh;
        width: 60%;
      }
      #mapWrapper{
        display: flex;
        align-items: center;
        justify-content: center;
      }
      html, body {
        height: 100%;
        margin: 0;
        padding: 20px;
      }
      #searchWrapper{
        padding:20px;
      }
      p{
        margin:0;
      }
      .inputWrapper{
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .titleSearch{
        padding: 20px 0px;
        font-weight: 900;
        font-size:2rem;
      }
      .hide{
        display: none;
      }
      .custom-select{
        margin: 0!important;
      }
      .mainColor{
        color:#1a1c85
      }
      .secondColor{
        color:#f7c30d;
      }
      .secondColorBg{
        background-color:#f7c30d;
      }
      .filterIntro{
        font-weight: bold;
      }
      .textBold{
        font-weight: bold;
      }
      button{
        border: 0;
        padding: 10px 20px;
        border-radius: 5px;
      }
      select, input{
        background-color: lightgray!important;
        color: gray!important;
        font-weight: 500!important;
      }
      #searchCourses{
        padding: 20px 0px;
      }
      #resultsWrapper{
        padding: 20px;
      }
      .card{
        background-color: #DDEEFF;
        margin: 10px 0px;
        padding:20px;
        flex-direction: row !important;
      }
      .card > h6{
        display: inline-block;
        width: 200px;
        margin: 20px;
      }
      .card > button {
        height: 50px;
      }
      #trainingDetails{
        display: inline-block;
        width: 400px;
        margin: 20px;
      }
    </style>
  </head>
  <body>
    <div id="searchWrapper" class="container">
      <p class="titleSearch mainColor">Toutes les prochaines sessions en région</p>
      <div class="">
          <p class="filterIntro mainColor">Filtrer par</p>
        </div>
      <div id="searchCourses">
        <div class="row">

          <div class="col-md-3 inputWrapper hide" id="datePickerWrap">
            <div class="input-group flex-nowrap"><input type="text" id="datepicker" class="form-control mb-3" placeholder="Date" aria-label="organisme"></div>
          </div>
        </div>
        <div class="">
          <button id="search" class="secondColorBg mainColor textBold">Rechercher</button>
        </div>
      </div>
    </div>
    <div id="mapWrapper">
      <div id="map"></div>
    </div>
    <div id="resultsWrapper" class="hide">
      <div>
        <h4 class="mainColor textBold">Vos résultats</h4>
      </div>
      <div id="results">

      </div>
    </div>


    <!-- BOOTSTRAP-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>


    <!-- DATE PICKER-->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
      $(document).ready(function() {
        $( "#datepicker" ).daterangepicker(
          {
            autoUpdateInput: true,
          }
        );
      } );
    </script>

    <!-- GOOGLE MAPS-->
    <script>

      // DATA
      var fields=[
        {
          label:"Région",
          name:"region",
          values:[
            {label:"Australie Occidentale", name:"WA"},
            {label:"Australie Méridionale", name:"SA"},
            {label:"Queensland",name:"QLD"},
            {label:"Territoire du Nord",name:"NT"},
            {label:"Nouvelle Galles",name:"VIC"}
          ],
          type:"select"
        },
        {
          label:"Département",
          name:"departement",
          values:[
            {label:"Departement 1", name:"dep1"},
            {label:"Departement 2", name:"dep2"},
            {label:"Departement 3", name:"dep3"},
            {label:"Departement 4", name:"dep4"},
            {label:"Departement 5", name:"dep5"}
          ],
          type:"select"
        },
        {
          label:"Organisme",
          values:[
            {label:"Acme", name:"Acme"},
            {label:"Footbook", name:"Footbook"},
            {label:"Pear", name:"Pear"},
            {label:"Amazing & Cie", name:"Amazing & Cie"},
          ],
          type:"select",
          name:"organisme"
        },
        {
          label:"Date",
          type:"dateRangePicker",
          name:"datepicker"
        },
      ]

      var locations = [
        {lat: 44.837789, lng: -0.57918, organisme:"Formateurs de Bordeaux", region:"Nouvelle-Aquitaine", departement:"Gironde", date:"13/11/2019", dateFin:"29/01/2020", lieu: "Bordeaux", tel: "01.00.00.00.00", adresse: "4 rue Rambervilliers", ouverte: true, url: "", title:"Formation de Bordeaux"},
        {lat: 47.216667, lng: -1.550000, organisme:"Formateurs de Nantes", region:"Pays de la Loire", departement:"Loire-Atlantique", date:"05/11/2019", dateFin:"15/01/2019", lieu: "Nantes", tel: "01.00.00.00.00", adresse: "4 rue Rambervilliers", ouverte: true, url: "", title:"Formation de Nantes"},
        {lat: 48.8534, lng: 2.3488, organisme:"Formateurs de Paris", region:"Île-de-France", departement:"Paris", date:"16/10/2019", dateFin:"20/11/2019", lieu: "Paris", tel: "01.00.00.00.00", adresse: "4 rue Rambervilliers", ouverte: true, url: "", title:"Formation de Paris"},
        {lat: 48.8534, lng: 2.3488, organisme:"Formateurs de Paris", region:"Île-de-France", departement:"Paris", date:"03/11/2019", dateFin:"22/12/2019", lieu: "Paris", tel: "01.00.00.00.00", adresse: "4 rue Rambervilliers", ouverte: true, url: "", title:"Formation de Paris"},
        {lat: 45.7500, lng: 4.8500, organisme:"Formateurs de Lyon", region:"Auvergne-Rhône-Alpes", departement:"Rhône", date:"19/11/2019", dateFin:"28/01/2020", lieu: "Lyon", tel: "01.00.00.00.00", adresse: "4 rue Rambervilliers", ouverte: true, url: "", title:"Formation de Lyon"},
        {lat: 43.600, lng: 1.433333, organisme:"Formateurs de Toulouse", region:"Occitanie", departement:"Haute-Garonne", date:"29/10/2019", dateFin:"10/12/2019", lieu: "Toulouse", tel: "01.00.00.00.00", adresse: "4 rue Rambervilliers", ouverte: true, url: "", title:"Formation de Toulouse"},
      ]
      var saveLocations = locations;

      // FUNCTIONS
      function buildSearchBar(fields){
        fields.map(function(field){
          if(field.type==="select"){
            var fieldInput='<div class="col-md-2 inputWrapper"> <select class="custom-select mb-3" id="'+field.name+'"><option value="'+field.name+'">'+field.label+'</option>';
            field.values.map((value)=>{
              fieldInput+='<option value="'+value.name+'">'+value.label+'</option>'
            })  
            fieldInput+='</select>';
            $('#searchCourses .row').append(fieldInput);
          }
          else if(field.type==="dateRangePicker"){
          $('#datePickerWrap').removeClass('hide'); 
          }
        })
      }
      
      function initMap() {
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 5,
          center: {lat: 46.8534, lng: 2.3488}
        });

        // Create an array of alphabetical characters used to label the markers.
        var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

        // Add some markers to the map.
        // Note: The code uses the JavaScript Array.prototype.map() method to
        // create an array of markers based on a given "locations" array.
        // The map() method here has nothing to do with the Google Maps API.
        var markers = locations.map(function(location, i) {
          return new google.maps.Marker({
            position: location,
            map: map,
            label: {
              text: labels[i % labels.length],
              color: 'white'
            },
            icon: {
              url: './icons/trainingIcon.png', // url
              scaledSize: new google.maps.Size(50, 50), // scaled size
              origin: new google.maps.Point(0, 0), // origin
              anchor: new google.maps.Point(25, 50), // anchor
              labelOrigin: new google.maps.Point(25, 18), // label offset
            },
          });
        });

        // create popup on markers
        (function (){
          // popup contents for markers
          var contentString = function (marker) {
            if (marker) {
              var openRegistration = '<h6 style="color:red>inscriptions fermées</h6>';
              if (marker.ouverte) {
                openRegistration =
                '<h6 style="color:green">inscriptions ouvertes</h6>'+
                '<button id="subscribeMarker" class="secondColorBg mainColor textBold">S\'inscrire</button>'
              }
              var content = '<div id="content">'+
              '<div id="siteNotice">'+
              '</div>'+
              '<h1 id="firstHeading">' + marker.organisme + ' - ' + marker.region + '</h1>'+
              '<div id="bodyContent">'+
              '<ul><li> Du ' + marker.date + ' au ' + marker.dateFin + '</li></ul>'+
              '<ul><li>' + marker.lieu + '</li></ul>'+
              '<ul><li>' + marker.adresse + '</li></ul>'+
              '<ul><li> tel : ' + marker.tel + '</li></ul>'+
              openRegistration+
              '</div>'+
              '</div>';

              return content
            } else {
              return 'ERROR marker does not exist'
            }
          };

          // create content for marker when clicked
          var infowindow = function (marker) {
            return new google.maps.InfoWindow({
            content: contentString(marker)
            });
          }

          // show popup on marker click.
          var clickedMarker;
          for (let i=0; i < markers.length; i++) {
            var marker = markers[i];
            markers[i].addListener('click', function() {
              if (clickedMarker) {
                clickedMarker.close();
              }
              clickedMarker = infowindow(locations[i]);
              clickedMarker.open(map, markers[i]);

              google.maps.event.addListener(clickedMarker,'domready',function() {
                if (locations[i].ouverte) {
                  displayRegistration('#subscribeMarker', locations[i].title);
                }
              });
            });
          }
        })();

        // Add a marker clusterer to manage the markers.
        var markerCluster = new MarkerClusterer(map, markers,
            {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
        }

      function filterData(){
        var selectedFilters=[];  
        fields.map(function(field){
          var fieldSearchValue = $('#'+field.name).val();
          selectedFilters.push({name:field.name, value:fieldSearchValue})
        })
        // console.log(selectedFilters)
        var selectedLocations = saveLocations.filter(function(location){
          var validLocation=true;
          selectedFilters.map(function(filter){
            //Avoid cases where field is datepicker type / search field value = search field name => means all results
            if(filter.name!=="datepicker" && filter.name!=filter.value && location[filter.name]!==filter.value){
              validLocation=false;
            }
            else if(filter.name==="datepicker" && filter.value!==""){
              var date1=moment(filter.value.split(' - ')[0]);
              var date2=moment(filter.value.split(' - ')[1]);
              var locationDate=moment(location['date']);
              if(locationDate<date1 || locationDate>date2){
                validLocation=false;
              }
            }
          })
          return validLocation;
        })
        return selectedLocations;
      }

      function displayResults(selectedLocations){
        // console.log(selectedLocations)
        if(selectedLocations.length>0){
          $('#results').html('');
          $('#results').append("<div class='container'><p>"+selectedLocations.length+" formations trouvées</p>")
          var index = 0;
          selectedLocations.map(function(selectedLocation){
            index++;
            id = 'subscribe' + index;
            var openRegistration = '<h6 style="color:red"">inscriptions fermées</h6>';
            if (selectedLocation.ouverte) {
              openRegistration =
              '<h6 style="color:green">inscriptions ouvertes</h6>'+
              '<button id='+id+' class="secondColorBg mainColor textBold">S\'inscrire</button>';
            }
            var courseReview =
            '<div class="card" >'+
            '<h6>Session du '+selectedLocation.date+' au '+selectedLocation.dateFin+'</h6>'+
            '<h6>'+selectedLocation.title+' </h6>'+
            '<div id="trainingDetails">';
              Object.entries(selectedLocation).map(function(locationInfo){
                if(locationInfo[0] !=="lat" && locationInfo[0]!=="lng" && locationInfo[0]!=="title" && locationInfo[0]!=="date" && locationInfo[0]!=="dateFin" && locationInfo[0]!=="lieu" && locationInfo[0]!=="ouverte" && locationInfo[0]!=="url"){
                  courseReview+='<p>'+locationInfo[0]+': '+locationInfo[1]+'</p>';
                }
              })
            courseReview+=
            '</div>'+
            '<h6>'+selectedLocation.lieu+'</h6>'+
            openRegistration+
            '</div></div>';
            $('#results').append(courseReview)
            if (selectedLocation.ouverte) {
              displayRegistration('#' + id, selectedLocation.title);
            }
          })
        }
        else{
          $('#results').html('<p>Aucun résultat ne correspond à votre recherche.</p>');
        }
        $('#resultsWrapper').removeClass('hide');
      }

      // ACTIONS
      $(document).ready(function(){
        var saveLocations=locations;
        buildSearchBar(fields);
        $('#datepicker').val('');
      });
      $("#search").on('click', function(){
        locations = filterData();
        displayResults(locations);
        initMap();
      });

      var displayRegistration = function (id, training) {
        $(id).on('click', function(){
          console.log('Afficher formulaire d\'inscription de : ' + training);   
        });
      }

    </script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBZPfRQkb-RFe5AUzHHmW_Q2ojvmIG8-AU&callback=initMap">
    </script>
  </body>
</html>