<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Courses Sessions</title>
    <!-- BOOTSTRAP-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <!-- DATE PICKER -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <!-- MOMENT JS-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/locale/fr.js"></script>

    <style>
      #map {
        height: 50vh;
        width: 60%;
      }
      #mapWrapper{
        display: flex;
        align-items: center;
        justify-content: center;
      }
      html, body {
        height: 100%;
        margin: 0;
        padding: 20px;
      }
      #searchWrapper{
        padding:20px;
      }
      .searchButton{
        display: inline-flex;
        margin-left: -200px;
      }
      .row{
        display: inline-flex;
      }
      p{
        margin:0;
      }
      .inputWrapper{
        display: flex;
        /* align-items: center; */
        justify-content: center;
      }
      .titleSearch{
        padding: 20px 0px;
        font-weight: 900;
        font-size:2rem;
      }
      .hide{
        display: none;
      }
      .custom-select{
        margin: 0!important;
      }
      .mainColor{
        color:#1a1c85
      }
      .secondColor{
        color:#f7c30d;
      }
      .secondColorBg{
        background-color:#f7c30d;
      }
      .filterIntro{
        font-weight: bold;
      }
      .textBold{
        font-weight: bold;
      }
      button{
        border: 0;
        padding: 10px 20px;
        border-radius: 5px;
      }
      select, input{
        background-color: lightgray!important;
        color: gray!important;
        font-weight: 500!important;
      }
      #searchCourses{
        padding: 20px 0px;
      }
      #resultsWrapper{
        padding: 20px;
      }
      .card{
        background-color: #DDEEFF;
        margin: 10px 0px;
        padding:20px;
        flex-direction: row !important;
      }
      .card > h6{
        display: inline-block;
        width: 200px;
        margin: 20px;
      }
      .card > button {
        height: 50px;
      }
      #trainingDetails{
        display: inline-block;
        width: 400px;
        margin: 20px;
      }
      #markerFirstHeading{
        font-size: 28px;
        font-weight: 900;
        margin-bottom: 0px;
        color: #145b90;
      }
      #markerBodyContent{
        color: #0a4e56;
        text-align: center;
      }
      #markerTrainingDates{
        display: inline-block;
      }
      #markerRegistration{
        display: inline-block;
        vertical-align: top;
        margin-left: 10px;
        text-align: center;
      }
      #markerTown{
        text-align: center;
        font-size: 16px;
        font-weight: 900;
        margin-bottom: 0px;
      }
      #markerDetails{
        text-align: center;
        margin-top: 0px;
      }
    </style>
  </head>
  <body>
    <div id="searchWrapper" class="container">
      <p class="titleSearch mainColor">Toutes les prochaines sessions en région</p>
      <div class="">
          <p class="filterIntro mainColor">Filtrer par</p>
        </div>
      <div id="searchCourses">
        <div class="row">

          <div class="col-md-3 inputWrapper hide" id="datePickerWrap">
            <div class="input-group flex-nowrap"><input type="text" id="datepicker" class="form-control mb-3" placeholder="Date" aria-label="organisme"></div>
          </div>
        </div>
        <div class="searchButton">
          <button id="search" class="secondColorBg mainColor textBold">Rechercher</button>
        </div>
      </div>
    </div>
    <div id="mapWrapper">
      <div id="map"></div>
    </div>
    <div id="resultsWrapper" class="hide">
      <div>
        <h4 class="mainColor textBold">Vos résultats</h4>
      </div>
      <div id="results">

      </div>
    </div>


    <!-- BOOTSTRAP-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>


    <!-- DATE PICKER-->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
      $(document).ready(function() {
        $( "#datepicker" ).daterangepicker(
          {
            autoUpdateInput: true,
          }
        );
      } );
    </script>

    <!-- GOOGLE MAPS-->
    <script>

      // DATA
      var locations = [
        {lat: 44.837789, lng: -0.57918, organisme:"Formateurs de Bordeaux", region:"Nouvelle-Aquitaine", departement:"Gironde", dates:[{debut:"13/11/2019",fin:"15/11/2019", ouverte: true}, {debut:"29/01/2020",fin:"31/01/2020", ouverte: true}], lieu: "Bordeaux", tel: "01.00.00.00.00", adresse: "4 rue Rambervilliers", url: "", title:"Formation de Bordeaux"},
        {lat: 47.216667, lng: -1.550000, organisme:"Formateurs de Nantes", region:"Pays de la Loire", departement:"Loire-Atlantique", dates:[{debut:"05/11/2019",fin:"07/11/2019", ouverte: true}, {debut:"15/01/2020",fin:"17/01/2020", ouverte: true}], lieu: "Nantes", tel: "01.00.00.00.00", adresse: "4 rue Rambervilliers", url: "", title:"Formation de Nantes"},
        {lat: 48.8534, lng: 2.3488, organisme:"Formateurs de Paris", region:"Île-de-France", departement:"Paris", dates:[{debut:"16/10/2019",fin:"18/10/2019", ouverte: true}, {debut:"20/11/2019",fin:"22/11/2019", ouverte: true}, {debut:"03/12/2019",fin:"05/12/2019", ouverte: true}, {debut:"22/01/2020",fin:"24/01/2020", ouverte: true}], lieu: "Paris", tel: "01.00.00.00.00", adresse: "4 rue Rambervilliers", url: "", title:"Formation de Paris"},
        {lat: 48.8534, lng: 2.3488, organisme:"Formateurs bis", region:"Île-de-France", departement:"Paris", dates:[{debut:"16/12/2019",fin:"18/12/2019", ouverte: true},], lieu: "Paris", tel: "01.00.00.00.00", adresse: "4 rue Rambervilliers", url: "", title:"Formation bis"},
        {lat: 45.7500, lng: 4.8500, organisme:"Formateurs de Lyon", region:"Auvergne-Rhône-Alpes", departement:"Rhône", dates:[{debut:"19/11/2019",fin:"21/11/2019", ouverte: true}, {debut:"28/01/2020",fin:"30/01/2020", ouverte: true}], lieu: "Lyon", tel: "01.00.00.00.00", adresse: "4 rue Rambervilliers", url: "", title:"Formation de Lyon"},
        {lat: 43.600, lng: 1.433333, organisme:"Formateurs de Toulouse", region:"Occitanie", departement:"Haute-Garonne", dates:[{debut:"29/10/2019",fin:"31/10/2019", ouverte: true}, {debut:"10/12/2019",fin:"12/12/2019", ouverte: true}], lieu: "Toulouse", tel: "01.00.00.00.00", adresse: "4 rue Rambervilliers", url: "", title:"Formation de Toulouse"},
      ]

      var saveLocations = (function () {
        var aggregateLocations = function (location, i) {
          i ++;
          for (var j = i; j < aggregatedLocationsList.length; j++) {
            if (location.lat === aggregatedLocationsList[j].lat && location.lng === aggregatedLocationsList[j].lng) {
              location.trainings.push(
                {
                  organisme: aggregatedLocationsList[j].organisme,
                  dates: aggregatedLocationsList[j].dates,
                  tel: aggregatedLocationsList[j].tel,
                  title: aggregatedLocationsList[j].title,
                }
              );
              aggregatedLocationsList.splice(j, 1);
              j--;
            }
          }
          delete location.organisme;
          delete location.dates;
          delete location.tel;
          delete location.title;
        };

        var aggregatedLocationsList = JSON.parse(JSON.stringify(locations));
        for (var i = 0; i < aggregatedLocationsList.length; i++) {
          aggregatedLocationsList[i].trainings = [];
          aggregatedLocationsList[i].trainings.push(
            {
              organisme: aggregatedLocationsList[i].organisme,
              dates: aggregatedLocationsList[i].dates,
              tel: aggregatedLocationsList[i].tel,
              title: aggregatedLocationsList[i].title,
            }
          );
          aggregateLocations(aggregatedLocationsList[i], i);
        }
        return aggregatedLocationsList
      })();

      var saveSessions = (function () {
        var buildASession = function (i, j) {
          var oneSession = JSON.parse(JSON.stringify(locations[i]));
          oneSession.dates = {
            debut: locations[i].dates[j].debut,
            fin: locations[i].dates[j].fin,
            ouverte: locations[i].dates[j].ouverte
          };
          return oneSession
        };

        var sessions = [];
        for (var i = 0; i < locations.length; i++) {
          for (var j = 0; j < locations[i].dates.length; j++) {
            sessions.push(buildASession(i, j));
          };
        }
        return sessions
      })();

      var getFieldValues = function (field) {
        values = [];
        for (var i = 0; i < locations.length; i++) {
          var alreadyExist = false;
          for (var j = 0; j < values.length; j++) {
            if (values[j] === locations[i][field]) {
              alreadyExist = true;
            }
          }
          if (!alreadyExist) {
            values.push(locations[i][field]);
          }
        }
        var fields = function (values) {
          fieldsList = [];
          for (var i = 0; i < values.length; i++) {
            fieldsList.push({label:values[i], name:values[i]})
          }
          return fieldsList
        }
        return fields(values);
      };

      var fields=[
        {
          label:'Région',
          name:'region',
          values:getFieldValues('region'),
          type:'select'
        },
        {
          label:'Département',
          name:'departement',
          values:getFieldValues('departement'),
          type:'select'
        },
        {
          label:'Organisme',
          name:'organisme',
          values:getFieldValues('organisme'),
          type:'select'
        },
        {
          label:'Date',
          type:'dateRangePicker',
          name:'datepicker'
        },
      ]

      // FUNCTIONS
      function buildSearchBar(fields){
        fields.map(function(field){
          if(field.type==="select"){
            var fieldInput='<div class="col-md-2 inputWrapper"> <select class="custom-select mb-3" id="'+field.name+'"><option value="'+field.name+'">'+field.label+'</option>';
            field.values.map((value)=>{
              fieldInput+='<option value="'+value.name+'">'+value.label+'</option>'
            })  
            fieldInput+='</select>';
            $('#searchCourses .row').append(fieldInput);
          }
          else if(field.type==="dateRangePicker"){
          $('#datePickerWrap').removeClass('hide'); 
          }
        })
      }
      
      function initMap() {
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 5,
          center: {lat: 46.8534, lng: 2.3488}
        });

        // Create an array of alphabetical characters used to label the markers.
        var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

        // Add some markers to the map.
        // Note: The code uses the JavaScript Array.prototype.map() method to
        // create an array of markers based on a given "locations" array.
        // The map() method here has nothing to do with the Google Maps API.
        var markers = saveLocations.map(function(location, i) {
          return new google.maps.Marker({
            position: location,
            map: map,
            label: {
              text: labels[i % labels.length],
              color: 'white'
            },
            icon: {
              url: './icons/trainingIcon.png', // url
              scaledSize: new google.maps.Size(50, 50), // scaled size
              origin: new google.maps.Point(0, 0), // origin
              anchor: new google.maps.Point(25, 50), // anchor
              labelOrigin: new google.maps.Point(25, 18), // label offset
            },
          });
        });

        // create popup on markers
        (function (){
          var markerSaved;
          // popup contents for markers
          var contentString = function (marker) {
            if (marker) {

              markerSaved = marker;

              // We create a liste with every sessions possible for the training
              var getDatesList = function (dates) {
                var list = '<ul id="markerTrainingDates">';
                for (var i = 0; i < dates.length; i++) {
                  list += '<li>Du ' + dates[i].debut + ' au ' + dates[i].fin;
                  if (dates[i].ouverte) {
                    list += '<span style="color:green"> inscriptions ouvertes</span>';
                  } else {
                    list += '<span style="color:red> inscriptions fermées</span>';
                  }
                  list +=  '</li>';
                }
                list += '</ul>'
                return list
              };

              // We check if there is at least one session open, if true we show registration button
              var openRegistration = function(dates, j) {
                for (var i = 0; i < dates.length; i++) {
                  if (dates[i].ouverte) {
                    return '<div id="markerRegistration">'+
                    '<button id="subscribeMarker'+j+'" class="secondColorBg mainColor textBold">S\'inscrire</button>'+
                    '</div>';
                  }
                }
                return ''
              }

              var content = '<div id="content">';
              for (let j = 0; j < marker.trainings.length; j++) {
                training = marker.trainings[j];
                content +=
                '</div>'+
                '<h1 id="markerFirstHeading">' + training.organisme + ' - ' + marker.region + '</h1>'+
                '<div id="markerBodyContent">'+
                '<div id="markerRegisterInfos">'+
                getDatesList(training.dates)+
                openRegistration(training.dates, j)+
                '</div>'+
                '</div>';
              }
              content +=
              '<div id="markerLocationInfos">'+
              '<p id="markerTown">' + marker.lieu + '</p>'+
              '<div id="markerDetails">' +
              '<p>' + marker.adresse + '</p>'+
              '<p> tel : ' + training.tel + '</p>'+
              '</div>'+
              '</div>';

              return content
            } else {
              return 'ERROR marker does not exist'
            }
          };

          // create content for marker when clicked
          var infowindow = function (marker) {
            return new google.maps.InfoWindow({
            content: contentString(marker)
            });
          }

          // show popup on marker click.
          var clickedMarker;
          for (let i=0; i < markers.length; i++) {
            var marker = markers[i];
            markers[i].addListener('click', function() {
              if (clickedMarker) {
                clickedMarker.close();
              }
              clickedMarker = infowindow(saveLocations[i]);
              clickedMarker.open(map, markers[i]);

              google.maps.event.addListener(clickedMarker,'domready',function() {
                console.log(markerSaved);
                for (let j = 0; j < markerSaved.trainings.length; j++) {
                  displayRegistration('#subscribeMarker'+j, markerSaved);
                }
              });
            });
          }
        })();

        // Add a marker clusterer to manage the markers.
        var markerCluster = new MarkerClusterer(map, markers,
            {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
        }

      var momentification = function (date) {
        date=date.split('/');
        date=date[2]+'-'+date[1]+'-'+date[0];
        return date
      }

      function filterData(forMarkers){
        var dataToFilter;
        if (forMarkers) {
          // data used for search results 
          dataToFilter = saveLocations;
        } else {
          // data used for marker generation
          dataToFilter = saveSessions;
        }
        var selectedFilters=[];  
        fields.map(function(field){
          var fieldSearchValue = $('#'+field.name).val();
          selectedFilters.push({name:field.name, value:fieldSearchValue})
        })
        // console.log(selectedFilters)
        var selectedLocations = dataToFilter.filter(function(location){
          var validLocation=true;
          selectedFilters.map(function(filter){
            //Avoid cases where field is datepicker type / search field value = search field name => means all results
            if(filter.name!=="datepicker" && filter.name!=filter.value && location[filter.name]!==filter.value){
              validLocation=false;
            }
            else if(filter.name==="datepicker" && filter.value!=="" && location.dates && location.dates.debut){
              var date1=filter.value.split(' - ')[0];
              date1 = momentification(date1);
              var date2=filter.value.split(' - ')[1];
              date2 = momentification(date2);
              locationDate = momentification(location.dates.debut);
              if(moment(locationDate).isBefore(date1) || moment(locationDate).isAfter(date2)){
                validLocation=false;
              }
            }
          })
          return validLocation;
        })
        return selectedLocations;
      }

      function displayResults(selectedLocations){
        if(selectedLocations.length>0){
          $('#results').html('');
          $('#results').append("<div class='container'><p>"+selectedLocations.length+" sessions de formations trouvées</p>")
          var index = 0;
          selectedLocations.map(function(selectedLocation){
              index++;
              id = 'subscribe' + index;
              var openRegistration = '<h6 style="color:red"">inscriptions fermées</h6>';
              if (selectedLocation.dates.ouverte) {
                openRegistration =
                '<h6 style="color:green">inscriptions ouvertes</h6>'+
                '<button id='+id+' class="secondColorBg mainColor textBold">S\'inscrire</button>';
              }
              var courseReview =
              '<div class="card" >'+
              '<h6>Session du '+selectedLocation.dates.debut+' au '+selectedLocation.dates.fin+'</h6>'+
              '<h6>'+selectedLocation.title+' </h6>'+
              '<div id="trainingDetails">';
              Object.entries(selectedLocation).map(function(locationInfo){
                if(locationInfo[0] !=="dates" && locationInfo[0] !=="lat" && locationInfo[0]!=="lng" && locationInfo[0]!=="title" && locationInfo[0]!=="lieu" && locationInfo[0]!=="ouverte" && locationInfo[0]!=="url"){
                  courseReview+='<p>'+locationInfo[0]+': '+locationInfo[1]+'</p>';
                }
              })
              courseReview+=
              '</div>'+
              '<h6>'+selectedLocation.lieu+'</h6>'+
              openRegistration+
              '</div></div>';
              $('#results').append(courseReview)
              if (selectedLocation.dates.ouverte) {
                displayRegistration('#' + id, selectedLocation);
              }
          })
        }
        else{
          $('#results').html('<p>Aucun résultat ne correspond à votre recherche.</p>');
        }
        $('#resultsWrapper').removeClass('hide');
      }

      // ACTIONS
      $(document).ready(function(){
        var saveLocations=locations;
        buildSearchBar(fields);
        $('#datepicker').val('');
      });
      $("#search").on('click', function(){
        // First filtering, that generate one result (location) per session
        locations = filterData();
        displayResults(locations);
        // There is is a second filtering exclusively for markers, because we do not want a marker for each session, only one marker for each training (wich contains X sessions)
        locations = filterData('forMarkers');
        initMap();
      });

      var displayRegistration = function (id, registration) {
        $(id).on('click', function(){
          if (registration.title) {
            console.log('Afficher formulaire d\'inscription de : ' + registration.title);
          } else if (registration.trainings) {
            console.log('Afficher formulaire d\'inscription de : ');
            for (let i = 0; i < registration.trainings.length; i++) {
              console.log(registration.trainings[i].title + ' ');
            }
          }
          // l'objet registration contient toutes les infos dont on a besoin pour pré-remplir les champs du formulaire d'inscription.
          // Ici faire l'appel du formulaire du microsite
        });
      }

    </script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBZPfRQkb-RFe5AUzHHmW_Q2ojvmIG8-AU&callback=initMap">
    </script>
  </body>
</html>